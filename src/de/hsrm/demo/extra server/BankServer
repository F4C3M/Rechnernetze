package de.hsrm.demo.coded;

import java.io.*;
import java.net.*;


public class BankServer {
    private final int port;

    public BankServer(int port) {
        this.port = port;
    }

    public void start() throws IOException {
        ServerSocket serverSocket = new ServerSocket(port);
        System.out.println("Der Bankserver läuft auf dem Port " + port);

        while (true) {
            Socket clientSocket = serverSocket.accept();
            System.out.println("Ein neuer Klient wird verbunden: " + clientSocket.getInetAddress());

            BufferedReader in = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));
            BufferedWriter out = new BufferedWriter(new OutputStreamWriter(clientSocket.getOutputStream()));

            String line;
            while ((line = in.readLine()) != null) {
                Message msg = Message.deserialize(line);

                switch (msg.getType()) {
                    case LOGIN -> {
                        LoginMessage logMsg = (LoginMessage) msg;
                        System.out.println("Login-Anfrage: " + login.getUsername());
                        out.write(new TextMessage("OK").serialize() + "\n");
                        out.flush();
                    }
                    case KONTOSTAND -> {
                        KontostandMessage kontoMsg = (KontostandMessage) msg;
                        System.out.println("Kontostand-Anfrage für: " + ks.getKontonummer());
                        out.write(new KontostandMessage(ks.getKontonummer(), 1234.56).serialize() + "\n");
                        out.flush();
                    }
                    case ABHEBEN -> {
                        AbhebenMessage abhebenMsg = (AbhebenMessage) msg;
                        System.out.println("Abhebungsanfrage: " + abheben.getBetrag() + " von " + abheben.getKontonummer());
                        out.write(new TextMessage("Bitte entnehmen Sie Ihr Geld").serialize() + "\n").flush();
                        out.write(new TextMessage("Abhebung erfolgreich").serialize() + "\n").flush();
                    }
                    case TEXTITEXT -> {
                        TextMessage textMsg = (TextMessage) msg;
                        System.out.println("Textnachricht vom Client: " + text.getContent());
                        out.write(new TextMessage("Server hat die Nachricht erhalten").serialize() + "\n");
                        out.flush();
                    }
                    default -> {
                        out.write(new ErrorMessage("Unbekannter Nachrichttyp").serialize() + "\n");
                        out.flush();
                    }
                }
            }
            clientSocket.close();
        }
    }

    public static void main(String[] args) throws IOException {
        new BankServer(5001).start();
    }
}